name: Xcode - Build and Analyze

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0.2'

    - name: Install dependencies
      run: |
        brew install cocoapods
        pod install

    - name: Set up Provisioning Profile
      run: |
        echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" > /tmp/AuthKey.p8
        xcrun altool --list-profiles -u ${{ secrets.APP_STORE_CONNECT_USERNAME }} -p ${{ secrets.APP_STORE_CONNECT_PASSWORD }}
        PROFILE_UUID=$(xcrun altool --list-profiles -u ${{ secrets.APP_STORE_CONNECT_USERNAME }} -p ${{ secrets.APP_STORE_CONNECT_PASSWORD }} | grep 'UUID' | head -n 1 | awk '{print $2}')
        echo "PROFILE_UUID=${PROFILE_UUID}" > $GITHUB_ENV

    - name: Build and Analyze
      run: |
        xcodebuild -project "Mis Mangas.xcodeproj" -scheme "Mis Mangas" -sdk iphoneos -destination 'platform=iOS Simulator,name=iPhone 12' CODE_SIGN_STYLE=Manual PROVISIONING_PROFILE_SPECIFIER=$PROFILE_UUID
      env:
        PROFILE_UUID: ${{ env.PROFILE_UUID }}
